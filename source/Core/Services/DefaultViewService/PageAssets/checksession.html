<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Check Session IFrame</title>
</head>
<body>
    <script id="cookie-name" type="application/json">{cookieName}</script>
    <script src="{rootUrl}/assets/app.crypto.min.js"></script>
    <script>
        var cookieName = document.getElementById("cookie-name").textContent.trim();
        
        function getCookies() {
            var allCookies = document.cookie;
            var cookies = allCookies.split(';');
            return cookies.map(function (value) {
                var parts = value.trim().split('=');
                if (parts.length === 2) {
                    return {
                        name: parts[0].trim(),
                        value: parts[1].trim()
                    };
                }
            }).filter(function (item) {
                return item && item.name && item.value;
            });
        }

        function getBrowserState() {
            var cookies = getCookies().filter(function (cookie) {
                return (cookie.name == cookieName);
            });
            return cookies[0] && cookies[0].value;
        }

        function hash(value) {
            var hash = KJUR.crypto.Util.sha256(value);
            return hextob64u(hash);
        }

        function computeSessionStateHash(clientId, origin, sessionId, salt) {
            return hash(clientId + origin + sessionId + salt);
        }

        function calculateSessionStateResult(clientId, origin, sessionState) {
            var parts = sessionState.split('.');
            if (parts.length !== 2) {
                return "error";
            }

            var clientHash = parts[0];

            var salt = parts[1];
            var currentSessionId = getBrowserState();
            var expectedHash = computeSessionStateHash(clientId, origin, currentSessionId, salt);

            return clientHash === expectedHash ? "unchanged" : "changed";
        }

        window.addEventListener("message", function (e) {
            try{
                console.log("message", e.origin, e.data);
                var parts = e.data.split(' ');
                if (parts.length === 2) {
                    var clientId = parts[0];
                    var sessionState = parts[1];
                    var origin = e.origin;

                    var result = calculateSessionStateResult(clientId, origin, sessionState);
                    e.source.postMessage(result, e.origin);
                }
                else {
                    e.source.postMessage("error", e.origin);
                }
            }
            catch(ex){
                e.source.postMessage("error", e.origin);
            }
        }, false);
    </script>
</body>
</html>